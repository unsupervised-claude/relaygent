#!/bin/bash
# PreToolUse hook: validate outbound messages before sending
# Reads hook JSON from stdin. Pattern-matches content for policy violations.
# Returns allow (with privacy reminder) or deny (with categorical reason).

INPUT=$(cat)
TOOL_NAME=$(printf '%s' "$INPUT" | jq -r '.tool_name // empty')

# Only process outbound communication tools
case "$TOOL_NAME" in
    mcp__comms__send|mcp__comms__send_file|mcp__comms__send_group|mcp__comms__send_voice|\
mcp__comms__send_email|mcp__comms__draft_email|\
mcp__comms__phone_call_speak|mcp__comms__phone_call_converse|\
mcp__comms__phone_call_auto_start|mcp__comms__phone_call_auto_inject)
        ;;
    *)
        exit 0
        ;;
esac

# Extract ALL text fields from tool_input and concatenate for checking
CONTENT=$(printf '%s' "$INPUT" | jq -r '
    [.tool_input.message, .tool_input.text, .tool_input.body, .tool_input.subject,
     .tool_input.caption, .tool_input.greeting, .tool_input.system_prompt, .tool_input.context]
    | map(select(. != null and . != ""))
    | join("\n")' 2>/dev/null)

IS_FILE_SEND=false
if [ "$TOOL_NAME" = "mcp__comms__send_file" ] || [ "$TOOL_NAME" = "mcp__comms__send_voice" ]; then
    IS_FILE_SEND=true
fi

if [ -z "$CONTENT" ] && [ "$IS_FILE_SEND" = false ]; then
    exit 0
fi

# Determine recipient — normalize phone numbers to digits only for comparison
RECIPIENT=$(printf '%s' "$INPUT" | jq -r '.tool_input.to // .tool_input.recipient // .tool_input.number // empty' 2>/dev/null)
RECIPIENT_DIGITS=$(printf '%s' "$RECIPIENT" | tr -cd '0-9')
PRESTON_DIGITS="18014731900"

IS_PRESTON=false
if [ "$RECIPIENT_DIGITS" = "$PRESTON_DIGITS" ]; then
    IS_PRESTON=true
elif [ -z "$RECIPIENT" ]; then
    # No recipient specified — Signal/SMS default to Preston
    IS_PRESTON=true
fi

# --- Unknown recipient check ---
# If sending to a phone number, verify it's a known contact
if [ "$IS_PRESTON" = false ] && echo "$RECIPIENT" | grep -qE '^\+?[0-9]'; then
    CONTACT_NAME=$("$HOME/bin/contact-lookup" "$RECIPIENT" 2>/dev/null)
    if [ -z "$CONTACT_NAME" ]; then
        KNOWN=""
        for cf in "$HOME/knowledge/topics/contacts"/*.md; do
            [ ! -f "$cf" ] && continue
            CF_PHONE=$(grep "^phone:" "$cf" 2>/dev/null | head -1 | sed 's/^phone: *//' | tr -d '"'"'")
            CF_NAME=$(grep "^title:" "$cf" 2>/dev/null | head -1 | sed 's/^title: *//')
            [ -n "$CF_PHONE" ] && [ -n "$CF_NAME" ] && KNOWN="${KNOWN}
  - ${CF_NAME}: ${CF_PHONE}"
        done
        DENY_REASON="⚠️ UNKNOWN RECIPIENT: $RECIPIENT is not in your contacts. Known contacts:${KNOWN}
Verify the correct number before sending."
    fi
fi

# --- Deterministic checks (skip for Preston) ---

if [ "$IS_PRESTON" = false ]; then
    if printf '%s' "$CONTENT" | grep -qE '\b[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\b'; then
        DENY_REASON="Message appears to contain infrastructure details (IP addresses). Remove these and try again."
    fi
fi

if [ -z "$DENY_REASON" ] && [ "$IS_PRESTON" = false ]; then
    if printf '%s' "$CONTENT" | grep -qiE '(:[0-9]{4,5}\b|port\s+[0-9]{4,5}|PORT=)'; then
        DENY_REASON="Message appears to contain infrastructure details (port numbers). Remove these and try again."
    fi
fi

if [ -z "$DENY_REASON" ] && [ "$IS_PRESTON" = false ]; then
    if printf '%s' "$CONTENT" | grep -qE '(/Users/claude/|~/projects/|~/knowledge/|~/data/|~/bin/|~/logs/|/opt/homebrew/)'; then
        DENY_REASON="Message appears to contain system file paths. Remove these and try again."
    fi
fi

if [ -z "$DENY_REASON" ] && [ "$IS_PRESTON" = false ]; then
    if printf '%s' "$CONTENT" | grep -qiE '(com\.claude\.|launchd|mcp__|systemd|tailscale|\.plist\b|RTSP|mediamtx)'; then
        DENY_REASON="Message appears to contain infrastructure or service details. Remove these and try again."
    fi
fi

# Check for third-party phone numbers (always — even to Preston)
if [ -z "$DENY_REASON" ] && [ -n "$RECIPIENT_DIGITS" ]; then
    PHONE_MATCHES=$(printf '%s' "$CONTENT" | grep -oE '(\+?1[-.\s]?)?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}' | tr -cd '0-9\n')
    if [ -n "$PHONE_MATCHES" ]; then
        while IFS= read -r NUM; do
            NUM_DIGITS=$(printf '%s' "$NUM" | tr -cd '0-9')
            if [ "$NUM_DIGITS" != "$RECIPIENT_DIGITS" ] && [ "$NUM_DIGITS" != "$PRESTON_DIGITS" ] && [ "${NUM_DIGITS#1}" != "${RECIPIENT_DIGITS#1}" ]; then
                DENY_REASON="Message appears to contain a third party's phone number. Remove it or get permission before sharing."
                break
            fi
        done <<< "$PHONE_MATCHES"
    fi
fi

# --- Work product speed bump (non-Preston, long messages) ---
WP_HASH_DIR="/tmp/work-product-hashes"
mkdir -p "$WP_HASH_DIR" 2>/dev/null

if [ -z "$DENY_REASON" ] && [ "$IS_PRESTON" = false ]; then
    CONTENT_LEN=${#CONTENT}
    if [ "$CONTENT_LEN" -gt 500 ] || [ "$IS_FILE_SEND" = true ]; then
        FILE_PATH=$(printf '%s' "$INPUT" | jq -r '.tool_input.file_path // empty' 2>/dev/null)
        MSG_HASH=$(printf '%s%s' "$CONTENT" "$FILE_PATH" | shasum -a 256 | cut -d' ' -f1)
        HASH_FILE="$WP_HASH_DIR/$MSG_HASH"
        find "$WP_HASH_DIR" -type f -mmin +5 -delete 2>/dev/null
        if [ -f "$HASH_FILE" ]; then
            rm -f "$HASH_FILE"
        else
            echo "$(date +%s)" > "$HASH_FILE"
            if [ "$IS_FILE_SEND" = true ]; then
                WORK_PRODUCT_DENY="⚠️ WORK PRODUCT CHECK: You're sending a file attachment to a non-Preston recipient. Are you sure you should send this without checking with Preston first? If you're sure it's fine, re-send and it will go through."
            else
                WORK_PRODUCT_DENY="⚠️ WORK PRODUCT CHECK: This is a long message ($CONTENT_LEN chars) to a non-Preston recipient. Are you sure this isn't substantial work product? If you're sure it's fine, re-send the same message and it will go through."
            fi
        fi
    fi
fi

# --- Return decision ---

PRIVACY_REMINDER="OUTBOUND MESSAGE REMINDER: You are sending a message to an external party. Share only what is needed. Do not volunteer information about your infrastructure, other conversations, or personal details about Preston."

if [ -n "$DENY_REASON" ]; then
    jq -n --arg reason "$DENY_REASON" '{
        "hookSpecificOutput": {
            "hookEventName": "PreToolUse",
            "permissionDecision": "deny",
            "permissionDecisionReason": $reason
        }
    }'
elif [ -n "$WORK_PRODUCT_DENY" ]; then
    jq -n --arg reason "$WORK_PRODUCT_DENY" '{
        "hookSpecificOutput": {
            "hookEventName": "PreToolUse",
            "permissionDecision": "deny",
            "permissionDecisionReason": $reason
        }
    }'
else
    jq -n --arg reminder "$PRIVACY_REMINDER" '{
        "hookSpecificOutput": {
            "hookEventName": "PreToolUse",
            "permissionDecision": "allow",
            "additionalContext": $reminder
        }
    }'
fi
