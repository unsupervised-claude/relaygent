#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
CONFIG_FILE="$HOME/.relaygent/config.json"
PID_DIR="$HOME/.relaygent"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'

load_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}Not set up yet. Run: ./setup.sh${NC}"; exit 1
    fi
    eval "$(python3 -c "
import json,shlex;c=json.load(open('$CONFIG_FILE'));s=c['services']
for k,v in[('HUB_PORT',c['hub']['port']),('FORUM_PORT',s['forum']['port']),
('NOTIF_PORT',s['notifications']['port']),('HS_PORT',s.get('hammerspoon',{}).get('port',8097)),
('DATA_DIR',c['paths']['data']),('KB_DIR',c['paths']['kb'])]:print(f'{k}={shlex.quote(str(v))}')
")"
    export RELAYGENT_DATA_DIR="$DATA_DIR" RELAYGENT_KB_DIR="$KB_DIR" RELAYGENT_HUB_PORT="$HUB_PORT"
    export HAMMERSPOON_PORT="$HS_PORT" RELAYGENT_FORUM_PORT="$FORUM_PORT" RELAYGENT_NOTIFICATIONS_PORT="$NOTIF_PORT"
}

check_port() {
    local port=$1 name=$2 pids=""
    if command -v lsof &>/dev/null; then
        pids=$(lsof -iTCP:"$port" -sTCP:LISTEN -t 2>/dev/null | head -3)
    elif command -v ss &>/dev/null; then
        pids=$(ss -tlnp "sport = :$port" 2>/dev/null | awk 'NR>1{match($0,/pid=([0-9]+)/,a); if(a[1]) print a[1]}' | head -3)
    fi
    if [ -n "$pids" ]; then
        echo -e "  ${RED}Port $port ($name) in use (pid $pids).${NC} Kill: ${YELLOW}kill $pids${NC}"
        return 1
    fi
}

ensure_venv() {
    local dir=$1
    if [ ! -d "$dir/.venv" ] || [ ! -f "$dir/.venv/bin/python3" ]; then
        rm -rf "$dir/.venv" 2>/dev/null
        if ! python3 -m venv "$dir/.venv" 2>/dev/null; then
            echo -e "  ${RED}Failed to create venv in $dir${NC}"; return 1
        fi
        if ! "$dir/.venv/bin/pip" install -q -r "$dir/requirements.txt" 2>&1 | tail -1; then
            echo -e "  ${RED}Failed to install deps in $dir${NC}"; return 1
        fi
    fi
}

start_service() {
    local name=$1 pidfile="$PID_DIR/$2.pid" logfile="$SCRIPT_DIR/logs/relaygent-$2.log"
    shift 2
    mkdir -p "$SCRIPT_DIR/logs"
    if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
        echo -e "  $name: ${GREEN}already running${NC}"
        return
    fi
    "$@" > "$logfile" 2>&1 &
    echo $! > "$pidfile"
    echo -e "  $name: ${GREEN}started${NC}"
}

stop_process() {
    local name=$1 pidfile="$PID_DIR/$2.pid"
    if [ -f "$pidfile" ]; then
        local pid; pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            # Graceful SIGTERM first, then SIGKILL after 3s
            pkill -TERM -P "$pid" 2>/dev/null || true
            kill -TERM "$pid" 2>/dev/null || true
            for _ in 1 2 3; do kill -0 "$pid" 2>/dev/null || break; sleep 1; done
            kill -0 "$pid" 2>/dev/null && kill -9 "$pid" 2>/dev/null || true
            echo -e "  $name: ${YELLOW}stopped${NC}"
        else
            echo -e "  $name: ${YELLOW}not running${NC}"
        fi
        rm -f "$pidfile"
    else
        echo -e "  $name: ${YELLOW}not running${NC}"
    fi
}

check_process() {
    local name=$1 pidfile="$PID_DIR/$2.pid"
    if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
        echo -e "  $name: ${GREEN}running${NC} (pid $(cat "$pidfile"))"
    else
        echo -e "  $name: ${RED}stopped${NC}"
    fi
}

do_start() {
    load_config
    echo -e "${CYAN}Starting Relaygent...${NC}"
    local port_ok=true
    check_port "$HUB_PORT" "Hub" || port_ok=false
    check_port "$FORUM_PORT" "Forum" || port_ok=false
    check_port "$NOTIF_PORT" "Notifications" || port_ok=false
    if [ "$port_ok" = false ]; then
        echo -e "\n  ${RED}Fix port conflicts above, then try again.${NC}"; exit 1
    fi
    # Computer-use backend
    if [ "$(uname)" = "Darwin" ]; then
        if ! pgrep -x Hammerspoon >/dev/null 2>&1; then
            if command -v open &>/dev/null && open -Ra Hammerspoon 2>/dev/null; then
                open -a Hammerspoon
                echo -e "  Hammerspoon: ${GREEN}launched${NC}"
            else
                echo -e "  Hammerspoon: ${YELLOW}not installed (computer-use unavailable)${NC}"
            fi
        else
            echo -e "  Hammerspoon: ${GREEN}already running${NC}"
        fi
    elif [ "$(uname)" = "Linux" ] && command -v xdotool &>/dev/null; then
        check_port "$HS_PORT" "Computer-use" || port_ok=false
        if [ "$port_ok" = true ]; then
            start_service "Computer-use (port $HS_PORT)" "computer-use" \
                env DISPLAY="${DISPLAY:-:0}" python3 "$SCRIPT_DIR/computer-use/linux-server.py"
        fi
    else
        echo -e "  Computer-use: ${YELLOW}unavailable (install xdotool scrot wmctrl)${NC}"
    fi
    # Hub — build if needed
    [ ! -d "$SCRIPT_DIR/hub/build" ] && echo "  Building hub..." && (cd "$SCRIPT_DIR/hub" && npm run build >/dev/null 2>&1)
    start_service "Hub (port $HUB_PORT)" "hub" env PORT="$HUB_PORT" node "$SCRIPT_DIR/hub/server.js"
    # Forum
    ensure_venv "$SCRIPT_DIR/forum"
    start_service "Forum (port $FORUM_PORT)" "forum" \
        "$SCRIPT_DIR/forum/.venv/bin/python3" "$SCRIPT_DIR/forum/server.py"
    # Notifications
    ensure_venv "$SCRIPT_DIR/notifications"
    start_service "Notifications (port $NOTIF_PORT)" "notifications" \
        "$SCRIPT_DIR/notifications/.venv/bin/python3" "$SCRIPT_DIR/notifications/server.py"
    # Relay — verify Claude auth before starting
    if ! claude -p 'hi' >/dev/null 2>&1; then
        echo -e "  Relay: ${RED}Claude not authenticated. Run 'claude' to log in first.${NC}"
    else
        start_service "Relay" "relay" \
            python3 "$SCRIPT_DIR/harness/relay.py"
    fi
    echo -e "\n  Dashboard: ${CYAN}http://localhost:$HUB_PORT/${NC}"
    echo -e "  Logs:      $SCRIPT_DIR/logs/\n"
}

do_stop() {
    load_config 2>/dev/null || true
    echo -e "${CYAN}Stopping Relaygent...${NC}"
    stop_process "Relay" "relay"
    # Kill any orphaned claude subprocesses spawned by the relay
    local claude_pids; claude_pids=$(pgrep -f "claude.*--print.*--session-id" 2>/dev/null) || true
    [ -n "$claude_pids" ] && kill -TERM $claude_pids 2>/dev/null && \
        echo -e "  Claude processes: ${YELLOW}cleaned up${NC}" || true
    stop_process "Computer-use" "computer-use"
    stop_process "Hub" "hub"
    stop_process "Forum" "forum"
    stop_process "Notifications" "notifications"
    # Fallback: kill by port if pidfiles were lost
    for port_name in "${HUB_PORT:-8080}:Hub" "${FORUM_PORT:-8085}:Forum" "${NOTIF_PORT:-8083}:Notifications"; do
        port="${port_name%%:*}"; name="${port_name##*:}"
        pids=""
        if command -v lsof &>/dev/null; then
            pids=$(lsof -iTCP:"$port" -sTCP:LISTEN -t 2>/dev/null) || true
        elif command -v ss &>/dev/null; then
            pids=$(ss -tlnp "sport = :$port" 2>/dev/null | awk 'NR>1{match($0,/pid=([0-9]+)/,a); if(a[1]) print a[1]}') || true
        fi
        [ -n "$pids" ] && kill $pids 2>/dev/null && \
            echo -e "  $name orphan (port $port): ${YELLOW}killed${NC}" || true
    done
    # Kill MCP servers and notification poller
    for pat in "mcp-chat\.mjs|mcp-server\.mjs" "notification-poller"; do
        local pids; pids=$(pgrep -f "$pat" 2>/dev/null) || true
        [ -n "$pids" ] && kill $pids 2>/dev/null || true
    done
    rm -f "$SCRIPT_DIR/harness/.relay.lock"
}

do_status() {
    load_config
    echo -e "${CYAN}Relaygent Status${NC}"
    check_process "Relay" "relay"
    check_process "Hub" "hub"
    check_process "Forum" "forum"
    check_process "Notifications" "notifications"
    if [ "$(uname)" = "Darwin" ]; then
        pgrep -x Hammerspoon >/dev/null 2>&1 && echo -e "  Hammerspoon: ${GREEN}running${NC}" \
            || echo -e "  Hammerspoon: ${RED}stopped${NC}"
    elif [ "$(uname)" = "Linux" ]; then
        check_process "Computer-use" "computer-use"
    fi
}

case "${1:-help}" in
    start)   do_start ;;
    stop)    do_stop; exit 0 ;;
    status)  do_status ;;
    restart) do_stop; sleep 1; do_start ;;
    logs)    tail -f "$SCRIPT_DIR"/logs/relaygent*.log 2>/dev/null || echo -e "${RED}No logs found${NC}" ;;
    orient)  bash "$SCRIPT_DIR/harness/orient.sh" ;;
    *)       echo "Usage: relaygent {start|stop|status|restart|logs|orient}" ;;
esac
