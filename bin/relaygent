#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
CONFIG_FILE="$HOME/.relaygent/config.json"
PID_DIR="$HOME/.relaygent"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'

load_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}Not set up yet. Run: ./setup.sh${NC}"; exit 1
    fi
    HUB_PORT=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['hub']['port'])")
    FORUM_PORT=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['services']['forum']['port'])")
    NOTIF_PORT=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['services']['notifications']['port'])")
    HS_PORT=$(python3 -c "import json; c=json.load(open('$CONFIG_FILE')); print(c.get('services',{}).get('hammerspoon',{}).get('port',8097))")
    DATA_DIR=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['paths']['data'])")
    KB_DIR=$(python3 -c "import json; print(json.load(open('$CONFIG_FILE'))['paths']['kb'])")
    export RELAYGENT_DATA_DIR="$DATA_DIR" RELAYGENT_KB_DIR="$KB_DIR"
    export RELAYGENT_HUB_PORT="$HUB_PORT" HAMMERSPOON_PORT="$HS_PORT"
    export RELAYGENT_FORUM_PORT="$FORUM_PORT" RELAYGENT_NOTIFICATIONS_PORT="$NOTIF_PORT"
}

check_port() {
    local port=$1 name=$2
    if lsof -iTCP:"$port" -sTCP:LISTEN -t >/dev/null 2>&1; then
        local pids; pids=$(lsof -iTCP:"$port" -sTCP:LISTEN -t 2>/dev/null | head -3)
        local proc; proc=$(lsof -iTCP:"$port" -sTCP:LISTEN 2>/dev/null | tail -1 | awk '{print $1}')
        echo -e "  ${RED}Port $port ($name) is already in use by: $proc (pid $pids)${NC}"
        echo -e "  ${YELLOW}Kill it with: kill $pids${NC}"
        return 1
    fi
    return 0
}

ensure_venv() {
    local dir=$1
    if [ ! -d "$dir/.venv" ] || [ ! -f "$dir/.venv/bin/python3" ]; then
        rm -rf "$dir/.venv" 2>/dev/null
        if ! python3 -m venv "$dir/.venv" 2>/dev/null; then
            echo -e "  ${RED}Failed to create venv in $dir${NC}"; return 1
        fi
        if ! "$dir/.venv/bin/pip" install -q -r "$dir/requirements.txt" 2>&1 | tail -1; then
            echo -e "  ${RED}Failed to install deps in $dir${NC}"; return 1
        fi
    fi
}

start_service() {
    local name=$1 pidfile="$PID_DIR/$2.pid" logfile="$SCRIPT_DIR/logs/relaygent-$2.log"
    shift 2
    mkdir -p "$SCRIPT_DIR/logs"
    if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
        echo -e "  $name: ${GREEN}already running${NC}"
        return
    fi
    "$@" > "$logfile" 2>&1 &
    echo $! > "$pidfile"
    echo -e "  $name: ${GREEN}started${NC}"
}

stop_process() {
    local name=$1 pidfile="$PID_DIR/$2.pid"
    if [ -f "$pidfile" ]; then
        local pid; pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            # Graceful SIGTERM first, then SIGKILL after 3s
            pkill -TERM -P "$pid" 2>/dev/null || true
            kill -TERM "$pid" 2>/dev/null || true
            for _ in 1 2 3; do
                kill -0 "$pid" 2>/dev/null || break
                sleep 1
            done
            if kill -0 "$pid" 2>/dev/null; then
                pkill -9 -P "$pid" 2>/dev/null || true
                kill -9 "$pid" 2>/dev/null || true
            fi
            echo -e "  $name: ${YELLOW}stopped${NC}"
        else
            echo -e "  $name: ${YELLOW}not running${NC}"
        fi
        rm -f "$pidfile"
    else
        echo -e "  $name: ${YELLOW}not running${NC}"
    fi
}

check_process() {
    local name=$1 pidfile="$PID_DIR/$2.pid"
    if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
        echo -e "  $name: ${GREEN}running${NC} (pid $(cat "$pidfile"))"
    else
        echo -e "  $name: ${RED}stopped${NC}"
    fi
}

do_start() {
    load_config
    echo -e "${CYAN}Starting Relaygent...${NC}"
    # Check all ports before starting anything
    local port_ok=true
    check_port "$HUB_PORT" "Hub" || port_ok=false
    check_port "$FORUM_PORT" "Forum" || port_ok=false
    check_port "$NOTIF_PORT" "Notifications" || port_ok=false
    if [ "$port_ok" = false ]; then
        echo -e "\n  ${RED}Fix port conflicts above, then try again.${NC}"
        echo -e "  ${YELLOW}Or choose a different hub port in ~/.relaygent/config.json${NC}"
        exit 1
    fi
    # Hammerspoon (computer-use) — macOS only
    if [ "$(uname)" = "Darwin" ] && command -v open &>/dev/null; then
        if ! pgrep -x Hammerspoon >/dev/null 2>&1; then
            if open -Ra Hammerspoon 2>/dev/null; then
                open -a Hammerspoon
                echo -e "  Hammerspoon: ${GREEN}launched${NC}"
            else
                echo -e "  Hammerspoon: ${YELLOW}not installed (computer-use unavailable)${NC}"
            fi
        else
            echo -e "  Hammerspoon: ${GREEN}already running${NC}"
        fi
    fi
    # Hub
    cd "$SCRIPT_DIR/hub"
    [ ! -d "build" ] && echo "  Building hub..." && npm run build >/dev/null 2>&1
    export PORT="$HUB_PORT"
    start_service "Hub (port $HUB_PORT)" "hub" node "$SCRIPT_DIR/hub/server.js"
    # Forum
    ensure_venv "$SCRIPT_DIR/forum"
    start_service "Forum (port $FORUM_PORT)" "forum" \
        "$SCRIPT_DIR/forum/.venv/bin/python3" "$SCRIPT_DIR/forum/server.py"
    # Notifications
    ensure_venv "$SCRIPT_DIR/notifications"
    start_service "Notifications (port $NOTIF_PORT)" "notifications" \
        "$SCRIPT_DIR/notifications/.venv/bin/python3" "$SCRIPT_DIR/notifications/server.py"
    # Relay — verify Claude auth before starting
    if ! claude -p 'hi' >/dev/null 2>&1; then
        echo -e "  Relay: ${RED}Claude not authenticated. Run 'claude' to log in first.${NC}"
    else
        start_service "Relay" "relay" \
            python3 "$SCRIPT_DIR/harness/relay.py"
    fi
    echo ""
    echo -e "  Dashboard: ${CYAN}http://localhost:$HUB_PORT/${NC}"
    echo -e "  Logs:      $SCRIPT_DIR/logs/"
    echo ""
}

do_stop() {
    load_config 2>/dev/null || true
    echo -e "${CYAN}Stopping Relaygent...${NC}"
    stop_process "Relay" "relay"
    # Kill orphaned claude subprocesses spawned by the relay
    local claude_pids; claude_pids=$(pgrep -f "claude.*--print" 2>/dev/null) || true
    [ -n "$claude_pids" ] && kill $claude_pids 2>/dev/null && \
        echo -e "  Claude processes: ${YELLOW}cleaned up${NC}" || true
    stop_process "Hub" "hub"
    stop_process "Forum" "forum"
    stop_process "Notifications" "notifications"
    # Fallback: kill by port if pidfiles were lost
    for port_name in "${HUB_PORT:-8080}:Hub" "${FORUM_PORT:-8085}:Forum" "${NOTIF_PORT:-8083}:Notifications"; do
        port="${port_name%%:*}"; name="${port_name##*:}"
        pids=$(lsof -iTCP:"$port" -sTCP:LISTEN -t 2>/dev/null) || true
        [ -n "$pids" ] && kill $pids 2>/dev/null && \
            echo -e "  $name orphan (port $port): ${YELLOW}killed${NC}" || true
    done
    # Kill MCP servers and notification poller
    local aux_pids; aux_pids=$(pgrep -f "mcp-chat\.mjs|mcp-server\.mjs|notification-poller" 2>/dev/null) || true
    [ -n "$aux_pids" ] && kill $aux_pids 2>/dev/null && \
        echo -e "  Auxiliary processes: ${YELLOW}cleaned up${NC}" || true
    rm -f "$SCRIPT_DIR/harness/.relay.lock"
}

do_status() {
    load_config
    echo -e "${CYAN}Relaygent Status${NC}"
    check_process "Relay" "relay"
    check_process "Hub" "hub"
    check_process "Forum" "forum"
    check_process "Notifications" "notifications"
    if [ "$(uname)" = "Darwin" ]; then
        if pgrep -x Hammerspoon >/dev/null 2>&1; then
            echo -e "  Hammerspoon: ${GREEN}running${NC}"
        else
            echo -e "  Hammerspoon: ${RED}stopped${NC}"
        fi
    fi
}

case "${1:-help}" in
    start)   do_start ;;
    stop)    do_stop; exit 0 ;;
    status)  do_status ;;
    restart) do_stop; sleep 1; do_start ;;
    logs)    tail -f "$SCRIPT_DIR"/logs/relaygent*.log 2>/dev/null || echo -e "${RED}No logs found${NC}" ;;
    orient)  bash "$SCRIPT_DIR/harness/orient.sh" ;;
    *)       echo "Usage: relaygent {start|stop|status|restart|logs|orient}" ;;
esac
